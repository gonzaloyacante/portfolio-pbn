// ============================================
// ANALYTICS & SECURITY - Enhanced
// ============================================

/// Analytics event tracking with aggregation support
model AnalyticLog {
  id         String   @id @default(uuid())
  eventType  String   // page_view, project_view, contact_submit, download, etc
  entityId   String?  // ID of related entity (project, category, etc)
  entityType String?  // project, category, contact, booking
  // Event data
  eventData  Json?    // Flexible JSON for event-specific data
  // Session tracking
  sessionId  String?
  // User tracking
  userId     String?  // If authenticated
  // Request metadata
  timestamp  DateTime @default(now())
  ipAddress  String?
  userAgent  String?
  referrer   String?
  // UTM tracking
  utmSource    String?
  utmMedium    String?
  utmCampaign  String?
  utmTerm      String?
  utmContent   String?
  // Geographic (optional, can be enriched)
  country    String?
  city       String?
  // Performance
  loadTime   Int?     // Page load time in ms
  // Metadata
  metadata   String?  @db.Text // Additional JSON data

  @@index([eventType, timestamp])
  @@index([entityType, entityId])
  @@index([sessionId])
  @@index([userId])
  @@index([ipAddress])
  @@map("analytic_logs")
}

/// Password reset tokens with enhanced security
model PasswordResetToken {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expiresAt DateTime
  // Security
  ipAddress String?
  userAgent String?
  used      Boolean  @default(false)
  usedAt    DateTime?
  // Audit
  createdAt DateTime @default(now())

  @@index([email])
  @@index([token, expiresAt])
  @@map("password_reset_tokens")
}

/// User sessions for tracking and security
model Session {
  id           String   @id @default(cuid())
  userId       String
  sessionToken String   @unique
  // Session data
  ipAddress    String?
  userAgent    String?
  device       String?  // mobile, desktop, tablet
  browser      String?
  os           String?
  // Geographic
  country      String?
  city         String?
  // Lifecycle
  expiresAt    DateTime
  lastActivity DateTime @default(now())
  isActive     Boolean  @default(true)
  // Audit
  createdAt    DateTime @default(now())

  @@index([userId, isActive])
  @@index([sessionToken])
  @@index([expiresAt])
  @@map("sessions")
}

/// Security events for monitoring and alerting
model SecurityEvent {
  id          String   @id @default(uuid())
  eventType   String   // login_failed, suspicious_activity, password_reset, etc
  severity    String   // low, medium, high, critical
  userId      String?
  email       String?
  ipAddress   String?
  userAgent   String?
  details     Json?    // Event-specific details
  resolved    Boolean  @default(false)
  resolvedAt  DateTime?
  resolvedBy  String?
  createdAt   DateTime @default(now())

  @@index([eventType, severity])
  @@index([userId])
  @@index([ipAddress])
  @@index([resolved])
  @@map("security_events")
}

/// IP blocking for security (rate limiting, ban, etc)
model BlockedIp {
  id         String   @id @default(cuid())
  ipAddress  String   @unique
  reason     String   // spam, brute_force, abuse
  severity   String   @default("medium") // low, medium, high
  blockedBy  String?  // User ID or "system"
  expiresAt  DateTime? // null = permanent
  isActive   Boolean  @default(true)
  // Stats
  hitCount   Int      @default(0)
  lastHitAt  DateTime?
  // Audit
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([ipAddress, isActive])
  @@index([expiresAt])
  @@map("blocked_ips")
}

