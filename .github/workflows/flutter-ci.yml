# ============================================================
# Flutter CI + Firebase App Distribution
# ============================================================
# Triggers:
#   - Push a 'develop' o 'main' con cambios en app/**
#   - PR hacia 'develop' o 'main' con cambios en app/**
#
# Jobs:
#   1. analyze  â†’ flutter analyze (0 warnings = pass)
#   2. test     â†’ flutter test
#   3. build    â†’ flutter build apk --release (solo en push, no en PR)
#   4. distribute â†’ Firebase App Distribution (solo push a develop/main)
#
# Secretos de GitHub requeridos (Settings â†’ Secrets and variables â†’ Actions):
#   FIREBASE_SERVICE_ACCOUNT_KEY  â†’ JSON de cuenta de servicio de Firebase
#   FIREBASE_APP_ID_ANDROID       â†’ App ID de Android en Firebase (ej. 1:xxx:android:yyy)
#   KEYSTORE_BASE64               â†’ Keystore en Base64 (openssl base64 -in release.keystore)
#   KEYSTORE_PASS                 â†’ ContraseÃ±a del keystore
#   KEY_ALIAS                     â†’ Alias de la clave dentro del keystore
#   KEY_PASS                      â†’ ContraseÃ±a de la clave
# ============================================================

name: Flutter CI

on:
  push:
    branches: [develop, main]
    paths:
      - 'app/**'
      - '.github/workflows/flutter-ci.yml'
  pull_request:
    branches: [develop, main]
    paths:
      - 'app/**'

concurrency:
  group: flutter-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # â”€â”€ 1. Analyze â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  analyze:
    name: ðŸ” Analyze & Format
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: app

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Verify formatting
        run: dart format --set-exit-if-changed lib/ test/

      - name: Analyze (0 issues)
        run: flutter analyze --fatal-infos

  # â”€â”€ 2. Test â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  test:
    name: ðŸ§ª Unit & Widget Tests
    runs-on: ubuntu-latest
    needs: analyze
    defaults:
      run:
        working-directory: app

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Run tests
        run: flutter test --reporter=expanded

  # â”€â”€ 3. Build & Distribute â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Solo se ejecuta en push directo (no en PRs) para ahorrar tiempo de CI.
  build-and-distribute:
    name: ðŸš€ Build APK + Distribute
    runs-on: ubuntu-latest
    needs: [analyze, test]
    if: github.event_name == 'push'
    defaults:
      run:
        working-directory: app

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Install dependencies
        run: flutter pub get

      # Crea el archivo .env que la app espera encontrar
      - name: Create .env file
        env:
          API_BASE_URL: ${{ github.ref == 'refs/heads/main' && 'https://paolabolivar.es' || 'https://dev.paolabolivar.es' }}
          ENVIRONMENT: ${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }}
          SENTRY_DSN: ${{ secrets.SENTRY_DSN_APP }}
          FCM_VAPID_KEY: ${{ secrets.FCM_VAPID_KEY }}
        run: |
          cat > .env << EOF
          API_BASE_URL=${API_BASE_URL}
          ENVIRONMENT=${ENVIRONMENT}
          SENTRY_DSN=${SENTRY_DSN}
          FCM_VAPID_KEY=${FCM_VAPID_KEY}
          EOF
          echo "âœ… .env creado para entorno: ${ENVIRONMENT}"

      # Restaura el keystore desde el secreto Base64
      - name: Decode Keystore
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
        run: |
          mkdir -p android/app/keystore
          echo "$KEYSTORE_BASE64" | base64 --decode > android/app/keystore/release.keystore
          echo "âœ… Keystore restaurado"

      # Crea key.properties para la firma del APK
      - name: Create key.properties
        env:
          KEYSTORE_PASS: ${{ secrets.KEYSTORE_PASS }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASS: ${{ secrets.KEY_PASS }}
        run: |
          cat > android/key.properties << EOF
          storePassword=${KEYSTORE_PASS}
          keyPassword=${KEY_PASS}
          keyAlias=${KEY_ALIAS}
          storeFile=keystore/release.keystore
          EOF
          echo "âœ… key.properties creado"

      # Build APK universal firmado
      - name: Build APK (release)
        run: |
          flutter build apk \
            --release \
            --target-platform android-arm64 \
            --split-debug-info=build/debug-symbols \
            --obfuscate
          echo "âœ… APK construido en build/app/outputs/flutter-apk/"

      # Determinar release notes segÃºn la rama
      - name: Prepare release notes
        id: notes
        run: |
          BRANCH="${{ github.ref_name }}"
          COMMIT="${{ github.sha }}"
          SHORT_SHA="${COMMIT:0:7}"
          if [ "$BRANCH" = "main" ]; then
            NOTES="ðŸš€ ProducciÃ³n â€” ${SHORT_SHA}"
          else
            NOTES="ðŸ§ª Staging (develop) â€” ${SHORT_SHA}"
          fi
          echo "notes=$NOTES" >> $GITHUB_OUTPUT
          echo "âœ… Release notes: $NOTES"

      # Subir a Firebase App Distribution
      - name: Upload to Firebase App Distribution
        uses: wzieba/Firebase-Distribution-Github-Action@v1
        with:
          appId: ${{ secrets.FIREBASE_APP_ID_ANDROID }}
          serviceCredentialsFileContent: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_KEY }}
          groups: admins
          releaseNotes: ${{ steps.notes.outputs.notes }}
          file: app/build/app/outputs/flutter-apk/app-release.apk

      # Guardar el APK como artefacto del workflow (30 dÃ­as)
      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: portfolio-pbn-${{ github.ref_name }}-${{ github.sha }}
          path: app/build/app/outputs/flutter-apk/app-release.apk
          retention-days: 30
