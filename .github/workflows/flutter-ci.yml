# ============================================================
# Flutter CI + Firebase App Distribution
# ============================================================
#
# ESTRATEGIA DE RAMAS:
#
#   develop â†’ Solo quality gates (analyze + test). SIN distribuciÃ³n.
#             Permite iterar rÃ¡pido y detectar errores antes de subir a main.
#
#   main    â†’ Quality gates + build release + distribuciÃ³n automÃ¡tica a
#             Firebase App Distribution (grupo 'admins').
#             Solo se activa en push directo a main (no en PRs).
#
# SECRETOS REQUERIDOS  (Settings â†’ Secrets and variables â†’ Actions):
#   FIREBASE_SERVICE_ACCOUNT_KEY  â†’ JSON de cuenta de servicio de Firebase
#                                    Firebase Console â†’ Project Settings â†’
#                                    Service Accounts â†’ Generate new private key
#   FIREBASE_APP_ID_ANDROID       â†’ ID de la app Android en Firebase
#                                    Firebase Console â†’ Project Settings â†’
#                                    General â†’ tu app Android â†’ App ID
#                                    Formato: 1:XXXXXXXXXX:android:XXXXXXXX
#   KEYSTORE_BASE64               â†’ Keystore firmado codificado en base64
#                                    openssl base64 -in release.keystore
#   KEYSTORE_PASS                 â†’ ContraseÃ±a del keystore
#   KEY_ALIAS                     â†’ Alias de la clave dentro del keystore
#   KEY_PASS                      â†’ ContraseÃ±a de la clave
#   SENTRY_DSN_APP                â†’ DSN de Sentry para la app Flutter
#                                    sentry.io â†’ tu proyecto â†’ Settings â†’ Keys
#   FCM_VAPID_KEY                 â†’ Clave pÃºblica VAPID para web push
#                                    Firebase Console â†’ Project Settings â†’
#                                    Cloud Messaging â†’ ConfiguraciÃ³n web â†’
#                                    Certificados push web â†’ Generar par de claves
# ============================================================

name: Flutter CI

on:
  push:
    branches: [develop, main]
    paths:
      - 'app/**'
      - '.github/workflows/flutter-ci.yml'
  pull_request:
    branches: [develop, main]
    paths:
      - 'app/**'

concurrency:
  group: flutter-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # â”€â”€ 1. Analyze â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  analyze:
    name: ðŸ” Analyze & Format
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: app

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Verify formatting
        run: dart format --set-exit-if-changed lib/ test/

      - name: Analyze (0 issues)
        run: flutter analyze --fatal-infos

  # â”€â”€ 2. Test â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  test:
    name: ðŸ§ª Unit & Widget Tests
    runs-on: ubuntu-latest
    needs: analyze
    defaults:
      run:
        working-directory: app

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Create minimal .env for tests
        run: |
          cat > .env << EOF
          API_BASE_URL=http://localhost:3000
          ENVIRONMENT=test
          SENTRY_DSN=
          FCM_VAPID_KEY=
          EOF

      - name: Run tests
        run: flutter test --reporter=expanded

  # â”€â”€ 3. Build & Distribute â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Solo se ejecuta cuando se hace push a 'main' (no en develop, no en PRs).
  # Representa una release aprobada lista para distribuir a los verificadores.
  build-and-distribute:
    name: ðŸš€ Build APK + Firebase App Distribution
    runs-on: ubuntu-latest
    needs: [analyze, test]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment: production
    defaults:
      run:
        working-directory: app

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Install dependencies
        run: flutter pub get

      # Crea el archivo .env con la configuraciÃ³n de producciÃ³n
      - name: Create .env file
        env:
          SENTRY_DSN: ${{ secrets.SENTRY_DSN_APP }}
          FCM_VAPID_KEY: ${{ secrets.FCM_VAPID_KEY }}
        run: |
          cat > .env << EOF
          API_BASE_URL=https://paolabolivar.es
          ENVIRONMENT=production
          SENTRY_DSN=${SENTRY_DSN}
          FCM_VAPID_KEY=${FCM_VAPID_KEY}
          EOF
          echo "âœ… .env creado para entorno: production"

      # Restaura el keystore desde el secreto Base64
      - name: Decode Keystore
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
        run: |
          mkdir -p android/keystore
          echo "$KEYSTORE_BASE64" | base64 --decode > android/keystore/release.keystore
          echo "âœ… Keystore restaurado"

      # Crea key.properties para la firma del APK
      - name: Create key.properties
        env:
          KEYSTORE_PASS: ${{ secrets.KEYSTORE_PASS }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASS: ${{ secrets.KEY_PASS }}
        run: |
          cat > android/key.properties << EOF
          storePassword=${KEYSTORE_PASS}
          keyPassword=${KEY_PASS}
          keyAlias=${KEY_ALIAS}
          storeFile=keystore/release.keystore
          EOF
          echo "âœ… key.properties creado"

      # Build APK universal firmado
      - name: Build APK (release)
        run: |
          flutter build apk \
            --release \
            --target-platform android-arm64 \
            --split-debug-info=build/debug-symbols \
            --obfuscate
          echo "âœ… APK construido en build/app/outputs/flutter-apk/"

      # Determinar release notes desde el Ãºltimo commit
      - name: Prepare release notes
        id: notes
        run: |
          COMMIT="${{ github.sha }}"
          SHORT_SHA="${COMMIT:0:7}"
          MSG="${{ github.event.head_commit.message }}"
          # Tomar solo la primera lÃ­nea del mensaje de commit
          FIRST_LINE=$(echo "$MSG" | head -1)
          NOTES="ðŸš€ ${FIRST_LINE} (${SHORT_SHA})"
          echo "notes=$NOTES" >> $GITHUB_OUTPUT
          echo "âœ… Release notes: $NOTES"

      # Subir a Firebase App Distribution
      # MÃ¡s info: https://github.com/wzieba/Firebase-Distribution-Github-Action
      - name: Upload to Firebase App Distribution
        uses: wzieba/Firebase-Distribution-Github-Action@v1
        with:
          appId: ${{ secrets.FIREBASE_APP_ID_ANDROID }}
          serviceCredentialsFileContent: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_KEY }}
          groups: admins
          releaseNotes: ${{ steps.notes.outputs.notes }}
          file: app/build/app/outputs/flutter-apk/app-release.apk

      # Guardar el APK como artefacto del workflow (30 dÃ­as)
      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: portfolio-pbn-${{ github.sha }}
          path: app/build/app/outputs/flutter-apk/app-release.apk
          retention-days: 30
