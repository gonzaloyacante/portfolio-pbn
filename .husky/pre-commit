#!/usr/bin/env sh

echo ""
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘      ğŸš€ PORTFOLIO PBN PRE-COMMIT VERIFICATION SUITE         â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# Track start time
START_TIME=$(date +%s)

# -----------------------------
# Web checks (Next.js / Node)
# -----------------------------
if [ -f "web/package.json" ]; then
  echo "ğŸ“ Detectado proyecto web en /web â€” ejecutando checks web"

  echo "ğŸ“‹ [web] Lint-Staged: Formateando archivos modificados..."
  if ! (cd web && pnpm exec --silent lint-staged); then
    echo "âŒ Error en web lint-staged. Revisa errores de formato/linting."
    exit 1
  fi
  echo "âœ… web lint-staged completado"

  echo "ğŸ” [web] TypeScript: Verificando tipos..."
  if ! (cd web && pnpm exec --silent tsc --noEmit); then
    echo "âŒ Error en web type checking. Revisa errores de TypeScript."
    exit 1
  fi
  echo "âœ… web TypeScript check completado"

  echo "ğŸ§¹ [web] ESLint: Verificando cÃ³digo..."
  if ! (cd web && pnpm exec --silent eslint "src/**/*.{ts,tsx}" --quiet); then
    echo "âŒ Error en web ESLint. Revisa errores."
    exit 1
  fi
  echo "âœ… web ESLint completado sin errores"

  echo "ğŸ—„ï¸  [web] Prisma: Validando schema (si aplica)..."
  if [ -d "web/prisma/schema" ] || [ -f "web/prisma/schema.prisma" ] || [ -f "web/prisma.config.ts" ]; then
    if ! (cd web && pnpm exec --silent prisma validate); then
      echo "âŒ Error en web Prisma schema. Revisa los archivos en web/prisma/."
      exit 1
    fi
    echo "âœ… web Prisma schema vÃ¡lido"
  else
    echo "â„¹ï¸  No se encontrÃ³ schema de Prisma en web/, saltando..."
  fi

  echo "ğŸ—ï¸  [web] Next.js: Verificando build de producciÃ³n (check only)..."
  if ! (cd web && pnpm exec --silent next build); then
    echo "âŒ Error en web build de Next.js. El cÃ³digo no compila correctamente."
    exit 1
  fi
  echo "âœ… web Build de producciÃ³n exitoso"
else
  echo "âš ï¸  No se encontrÃ³ web/package.json â€” saltando checks web"
fi

# -----------------------------
# App checks (Flutter/Dart)
# -----------------------------
if [ -f "app/pubspec.yaml" ]; then
  echo "ğŸ“ Detectado proyecto app en /app â€” ejecutando checks app"
  if command -v flutter >/dev/null 2>&1; then
    echo "ğŸ” [app] Flutter analyze"
    if ! (cd app && flutter analyze); then
      echo "âŒ Error en flutter analyze. Revisa problemas en app/."
      exit 1
    fi
    echo "âœ… Flutter analyze completado"
  else
    echo "âš ï¸  Flutter no estÃ¡ instalado en el entorno; salto checks app"
  fi
else
  echo "âš ï¸  No se encontrÃ³ app/pubspec.yaml â€” saltando checks app"
fi

# -----------------------------
# Verificaciones finales (config files)
# -----------------------------
echo "âš™ï¸  Verificando archivos de configuraciÃ³n crÃ­ticos..."
CONFIG_OK=true
for config_file in "web/next.config.ts" "web/tsconfig.json" "web/package.json" "web/tailwind.config.ts"; do
  if [ -f "$config_file" ]; then
    echo "  âœ“ $config_file"
  else
    echo "  âœ— $config_file faltante!"
    CONFIG_OK=false
  fi
done

if [ "$CONFIG_OK" = false ]; then
  echo "âŒ Archivos de configuraciÃ³n faltantes en web/. Revisa antes de commitear."
  exit 1
fi

# Calcular tiempo total
END_TIME=$(date +%s)
DURATION=$((END_TIME - START_TIME))

echo ""
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘     âœ… TODAS LAS VERIFICACIONES COMPLETADAS EXITOSAMENTE    â•‘"
echo "â•‘                   Tiempo total: ${DURATION}s                        â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "ğŸ“¦ Listo para commit seguro. Â¡CÃ³digo de calidad garantizada!"
