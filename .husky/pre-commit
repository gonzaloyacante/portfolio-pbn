#!/usr/bin/env sh

echo ""
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘      ğŸš€ PORTFOLIO PBN PRE-COMMIT VERIFICATION SUITE         â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# Ejecutar desde la raÃ­z del repo (husky corre desde ahÃ­)
# La parte web vive en `web/`. No se hace referencia a un `package.json` en la raÃ­z.
# Si no existe `web/package.json` ni `app/pubspec.yaml` avisamos pero no fallamos.
if [ ! -f "web/package.json" ] && [ ! -f "app/pubspec.yaml" ]; then
  echo "âŒ Error: no se encontrÃ³ web/package.json ni app/pubspec.yaml. No hay checks aplicables."
  exit 1
fi

START_TIME=$(date +%s)

# Detectar herramienta para ejecutar comandos (npx o pnpm exec)
if command -v npx >/dev/null 2>&1; then
  NPX_CMD="npx"
else
  NPX_CMD="pnpm exec"
fi

# No se permiten bypass. Si falla un check, el hook debe fallar.

echo "ğŸ“‹ [1/7] Lint-Staged: Formateando archivos modificados..."
# Ejecutar solo si hay archivos staged relevantes
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)
if printf "%s" "$STAGED_FILES" | grep -E '\.(ts|tsx|js|jsx|json|md)$' >/dev/null 2>&1; then
  # Ejecutar lint-staged desde web/ si existe (prettier y plugins estÃ¡n en web/devDependencies)
  if [ -f "web/package.json" ]; then
    if command -v pnpm >/dev/null 2>&1; then
      if ! (cd web && pnpm exec lint-staged); then
        echo "âŒ Error en lint-staged (web). Revisa errores de formato/linting en web/."
        exit 1
      fi
    else
      if ! (cd web && npx lint-staged); then
        echo "âŒ Error en lint-staged (web). Revisa errores de formato/linting en web/."
        exit 1
      fi
    fi
  else
    echo "âŒ Error: hay archivos staged que requieren formateo/linting pero falta web/package.json."
    exit 1
  fi
  echo "âœ… Lint-staged completado"
else
  echo "â„¹ï¸  No hay archivos staged relevantes para lint-staged, saltando..."
fi
echo ""

echo "ğŸ” [2/7] TypeScript: Verificando tipos en 'web' si existe..."
if [ -f "web/tsconfig.json" ]; then
  if ! (cd web && $NPX_CMD tsc --noEmit); then
    echo "âŒ Error en type checking dentro de web. Revisa errores de TypeScript en web/."
    exit 1
  fi
  echo "âœ… TypeScript type check (web) completado"
else
  echo "â„¹ï¸  web/tsconfig.json no existe, saltando type check para web"
fi
echo ""

echo "ğŸ§¹ [3/7] ESLint: Verificando cÃ³digo en 'web'..."
if [ -d "web/src" ]; then
  if ! (cd web && $NPX_CMD eslint "src/**/*.{ts,tsx,js,jsx}" --quiet); then
    echo "âŒ Error en ESLint (web). Revisa errores en web/src/."
    exit 1
  fi
  echo "âœ… ESLint (web) completado sin errores"
else
  echo "â„¹ï¸  web/src no existe, saltando ESLint para web"
fi
echo ""

echo "ğŸ—„ï¸  [4/7] Prisma: Validando schema en 'web/prisma' si existe..."
if [ -d "web/prisma" ] || [ -d "web/prisma/schema" ] || [ -f "web/prisma/schema.prisma" ] || [ -f "web/prisma/prisma.config.ts" ]; then
  if ! (cd web && $NPX_CMD prisma validate); then
    echo "âŒ Error en Prisma schema (web). Revisa los archivos en web/prisma/."
    exit 1
  fi
  echo "âœ… Prisma schema (web) vÃ¡lido"
else
  echo "â„¹ï¸  No se encontrÃ³ schema de Prisma en web/, saltando..."
fi
echo ""

echo "ğŸ—ï¸  [5/7] Next.js: Verificando build de producciÃ³n en 'web' (puede ser pesado)..."
if [ -f "web/package.json" ]; then
  if ! (cd web && $NPX_CMD next build); then
    echo "âŒ Error en build de Next.js (web). El cÃ³digo no compila correctamente."
    exit 1
  fi
  echo "âœ… Build de producciÃ³n (web) exitoso"
else
  echo "â„¹ï¸  No se encontrÃ³ web/package.json â€” no se ejecutan checks de Next.js para web"
fi
echo ""

echo "ğŸ” [6/7] Comprobaciones extra: scripts y dependencias en web/package.json"
if [ -f "web/package.json" ]; then
  # Verificar que prisma estÃ© en dependencias dev o scripts apunten a web/prisma
  if (grep -q 'prisma' web/package.json); then
    echo "  âœ“ Prisma declarado en web/package.json"
  else
    echo "  âš ï¸  Prisma no encontrado en web/package.json â€” verifica que estÃ© correctamente declarado (expected in web)."
  fi
fi
echo ""

echo "ğŸ“± [7/7] Flutter/Dart: Formato y anÃ¡lisis en 'app' si existe (puede ser pesado)..."
if [ -f "app/pubspec.yaml" ]; then
  if [ "${SKIP_APP}" = "1" ]; then
    echo "âš¡ SKIP_APP activo: saltando checks de app"
  else
    # Preferir dart si estÃ¡ disponible, fallback a flutter
    if command -v dart >/dev/null 2>&1; then
      echo "ğŸ”§ Usando 'dart' para formateo y anÃ¡lisis en app/"
      if ! (cd app && dart format --output=none --set-exit-if-changed .); then
        echo "âŒ Formateo Dart fallido (app). EjecutÃ¡ 'dart format .' y corregÃ­ los archivos."
        exit 1
      fi
      if ! (cd app && dart analyze); then
        echo "âŒ Dart analyze encontrÃ³ problemas en app/."
        exit 1
      fi
    elif command -v flutter >/dev/null 2>&1; then
      echo "ğŸ”§ Usando 'flutter' para formateo y anÃ¡lisis en app/"
      if ! (cd app && flutter format .); then
        echo "âŒ Formateo Flutter fallido (app). EjecutÃ¡ 'flutter format .' y corregÃ­ los archivos."
        exit 1
      fi
      if ! (cd app && flutter analyze); then
        echo "âŒ Flutter analyze encontrÃ³ problemas en app/."
        exit 1
      fi
    else
      echo "â„¹ï¸  No se encontrÃ³ 'dart' ni 'flutter' en PATH â€” saltando checks de app"
    fi
    echo "âœ… Checks de app completados"
  fi
else
  echo "â„¹ï¸  No se encontrÃ³ app/pubspec.yaml, saltando checks para app"
fi
echo ""

echo "âš™ï¸  [7/7] Verificando archivos de configuraciÃ³n principales (web)..."
for config_file in "web/package.json" "web/next.config.ts" "web/tsconfig.json" "web/tailwind.config.ts"; do
  if [ -f "$config_file" ]; then
    echo "  âœ“ $config_file"
  else
    echo "  âœ— $config_file faltante (o no aplicable)"
  fi
done

END_TIME=$(date +%s)
DURATION=$((END_TIME - START_TIME))

echo ""
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘     âœ… VERIFICACIONES COMPLETADAS (PARCIALES/CONDICIONALES) â•‘"
echo "â•‘                   Tiempo total: ${DURATION}s                        â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "ğŸ“¦ Pre-commit checks ejecutados. Si fallÃ³ algo, ver mensajes arriba."
