#!/usr/bin/env sh

echo ""
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘         PORTFOLIO PBN PRE-PUSH VERIFICATION SUITE           â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

if [ ! -f "package.json" ]; then
  echo "âŒ Error: package.json no encontrado. Ejecutar desde la raÃ­z del proyecto."
  exit 1
fi

START_TIME=$(date +%s)

# Detectar npx o pnpm exec
if command -v npx >/dev/null 2>&1; then
  NPX_CMD="npx"
else
  NPX_CMD="pnpm exec"
fi

SKIP_WEB=${HUSKY_SKIP_WEB:-0}
SKIP_APP=${HUSKY_SKIP_APP:-0}

echo "ğŸ” Ejecutando pre-push checks (SKIP_WEB=${SKIP_WEB}, SKIP_APP=${SKIP_APP})"

if [ "${SKIP_WEB}" != "1" ]; then
  echo "\nğŸ—ï¸  Comprobaciones para 'web'..."
  if [ -f "web/package.json" ]; then
    # Type check
    if [ -f "web/tsconfig.json" ]; then
      echo "ğŸ”¸ TypeScript check (web)"
      if ! (cd web && $NPX_CMD tsc --noEmit); then
        echo "âŒ TypeScript errors in web/"
        exit 1
      fi
    fi

    # ESLint
    if [ -d "web/src" ]; then
      echo "ğŸ”¸ ESLint (web)"
      if ! (cd web && $NPX_CMD eslint "src/**/*.{ts,tsx,js,jsx}" --max-warnings=0); then
        echo "âŒ ESLint errors in web/"
        exit 1
      fi
    fi

    # Prisma validate
    if [ -d "web/prisma" ] || [ -f "web/prisma/schema.prisma" ]; then
      echo "ğŸ”¸ Prisma validate (web)"
      if ! (cd web && $NPX_CMD prisma validate); then
        echo "âŒ Prisma schema issues in web/"
        exit 1
      fi
    fi

    # Next build (production) - can be heavy
    echo "ğŸ”¸ Next.js build (web) â€” this may be slow"
    if ! (cd web && $NPX_CMD next build); then
      echo "âŒ Next build failed for web/"
      exit 1
    fi
  else
    echo "â„¹ï¸  No se encontrÃ³ web/package.json â€” saltando checks web"
  fi
else
  echo "âš¡ SKIP_WEB activo: saltando checks para web"
fi

if [ "${SKIP_APP}" != "1" ]; then
  echo "\nğŸ“± Comprobaciones para 'app'..."
  if [ -f "app/pubspec.yaml" ]; then
    if command -v dart >/dev/null 2>&1; then
      echo "ğŸ”¸ Dart format + analyze (app)"
      if ! (cd app && dart format --output=none --set-exit-if-changed .); then
        echo "âŒ Dart format changed files in app/ â€” run 'dart format .'"
        exit 1
      fi
      if ! (cd app && dart analyze); then
        echo "âŒ Dart analyze found issues in app/"
        exit 1
      fi
    elif command -v flutter >/dev/null 2>&1; then
      echo "ğŸ”¸ Flutter format + analyze (app)"
      if ! (cd app && flutter format .); then
        echo "âŒ Flutter format failed in app/"
        exit 1
      fi
      if ! (cd app && flutter analyze); then
        echo "âŒ Flutter analyze found issues in app/"
        exit 1
      fi
    else
      echo "â„¹ï¸  No se encontrÃ³ 'dart' ni 'flutter' en PATH â€” saltando checks app"
    fi
  else
    echo "â„¹ï¸  No se encontrÃ³ app/pubspec.yaml â€” saltando checks app"
  fi
else
  echo "âš¡ SKIP_APP activo: saltando checks para app"
fi

END_TIME=$(date +%s)
DURATION=$((END_TIME - START_TIME))

echo ""
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘     âœ… PRE-PUSH CHECKS COMPLETADOS                            â•‘"
echo "â•‘                   Tiempo total: ${DURATION}s                        â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

exit 0
