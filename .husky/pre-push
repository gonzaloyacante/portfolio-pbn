#!/usr/bin/env sh

echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โ         PORTFOLIO PBN PRE-PUSH VERIFICATION SUITE           โ"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""

if [ ! -f "web/package.json" ] && [ ! -f "app/pubspec.yaml" ]; then
  echo "โ Error: no se encontrรณ web/package.json ni app/pubspec.yaml. No hay checks aplicables."
  exit 1
fi

START_TIME=$(date +%s)

# Detectar npx o pnpm exec
if command -v npx >/dev/null 2>&1; then
  NPX_CMD="npx"
else
  NPX_CMD="pnpm exec"
fi

SKIP_WEB=${HUSKY_SKIP_WEB:-0}
SKIP_APP=${HUSKY_SKIP_APP:-0}

echo "๐ Ejecutando pre-push checks (SKIP_WEB=${SKIP_WEB}, SKIP_APP=${SKIP_APP})"

echo "\n๐๏ธ  Comprobaciones para 'web'..."
if [ -f "web/package.json" ]; then
    # Type check
    if [ -f "web/tsconfig.json" ]; then
      echo "๐ธ TypeScript check (web)"
      if ! (cd web && $NPX_CMD tsc --noEmit); then
        echo "โ TypeScript errors in web/"
        exit 1
      fi
    fi

    # ESLint
    if [ -d "web/src" ]; then
      echo "๐ธ ESLint (web)"
      if ! (cd web && $NPX_CMD eslint "src/**/*.{ts,tsx,js,jsx}" --max-warnings=0); then
        echo "โ ESLint errors in web/"
        exit 1
      fi
    fi

    # Prisma validate
    if [ -d "web/prisma" ] || [ -f "web/prisma/schema.prisma" ]; then
      echo "๐ธ Prisma validate (web)"
      if ! (cd web && $NPX_CMD prisma validate); then
        echo "โ Prisma schema issues in web/"
        exit 1
      fi
    fi

    # Next build (production) - can be heavy
    echo "๐ธ Next.js build (web) โ this may be slow"
    if ! (cd web && $NPX_CMD next build); then
      echo "โ Next build failed for web/"
      exit 1
    fi
  else
    echo "โน๏ธ  No se encontrรณ web/package.json โ saltando checks web"
  fi
 

if [ "${SKIP_APP}" != "1" ]; then
  echo "\n๐ฑ Comprobaciones para 'app'..."
  if [ -f "app/pubspec.yaml" ]; then
    if command -v dart >/dev/null 2>&1; then
      echo "๐ธ Dart format + analyze (app)"
      if ! (cd app && dart format --output=none --set-exit-if-changed .); then
        echo "โ Dart format changed files in app/ โ run 'dart format .'"
        exit 1
      fi
      if ! (cd app && dart analyze); then
        echo "โ Dart analyze found issues in app/"
        exit 1
      fi
    elif command -v flutter >/dev/null 2>&1; then
      echo "๐ธ Flutter format + analyze (app)"
      if ! (cd app && flutter format .); then
        echo "โ Flutter format failed in app/"
        exit 1
      fi
      if ! (cd app && flutter analyze); then
        echo "โ Flutter analyze found issues in app/"
        exit 1
      fi
    else
      echo "โน๏ธ  No se encontrรณ 'dart' ni 'flutter' en PATH โ saltando checks app"
    fi
  else
    echo "โน๏ธ  No se encontrรณ app/pubspec.yaml โ saltando checks app"
  fi
else
  echo "โก SKIP_APP activo: saltando checks para app"
fi

END_TIME=$(date +%s)
DURATION=$((END_TIME - START_TIME))

echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โ     โ PRE-PUSH CHECKS COMPLETADOS                            โ"
echo "โ                   Tiempo total: ${DURATION}s                        โ"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""

exit 0
